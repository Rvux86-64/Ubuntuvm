name: Build UEFI App

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install required packages
      run: |
        sudo apt update
        sudo apt install -y build-essential gcc g++ binutils \
            gnu-efi  mtools parted wget curl sbsigntool

    - name: Download full GNU-EFI sources (GitHub runner lacks .lds + crt0)
      run: |
        wget https://sourceforge.net/projects/gnu-efi/files/latest/download -O gnu-efi.tar.gz
        mkdir gnu-efi-src
        tar xf gnu-efi.tar.gz -C gnu-efi-src --strip-components=1
        cd gnu-efi-src
        make
        cd ./gnuefi/
        make
        cd ../../ 
        find ./gnu-efi-src/ -name "libgnuefi.a"

       

    - name: Build UEFI App
      run: |
        make
        make image
        make clean
        ls ./
        file -s HamzaOS.iso
        sudo mkdir ./mnt
        curl https://drive.usercontent.google.com/download?id=17on23K6UUziXz95QbyhJvy8fAAhgbKVB&export=download&authuser=1 && curl "https://drive.google.com/uc?export=download&id=1Cv7tSkV3VKDcuKm9Ijxrxi_VgNXTBUhI"
        curl https://drive.google.com/uc?export=download&id=16wWMmhqsvSCOhNfJvupe-LjLfIj-7jIT && sbsign --key DB.key --cert DB.crt --output tmp.efi BOOTX64.efi && rm BOOTX64.efi && mv tmp.efi BOOTX64.efi

    - name: Upload BOOTX64.efi artifact
      uses: actions/upload-artifact@v4
      with:
        name: BOOTX64-efi
        path: BOOTX64.efi
    - name: Upload .iso artifact
      uses: actions/upload-artifact@v4
      with:
        name: HamzaOS.iso
        path: HamzaOS.iso
